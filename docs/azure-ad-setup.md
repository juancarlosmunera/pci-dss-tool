# Azure AD App Registration & SCIM Setup

This guide walks through the complete Azure portal configuration required to run the PCI DSS Compliance Platform. You will need **Global Administrator** or **Application Administrator** privileges in your Azure tenant.

---

## Overview of what you're setting up

| Component | Why |
|---|---|
| App Registration | Allows the platform to authenticate users via Microsoft SSO |
| App Roles | Defines the four platform roles (Admin, ControlOwner, Operator, Viewer) |
| Enterprise Application | Where you assign Entra groups to roles and configure SCIM |
| SCIM Provisioning | Azure automatically creates/deactivates users before they log in |

---

## Part 1 — App Registration

### 1.1 Create the App Registration

1. Go to **Azure Portal → Microsoft Entra ID → App registrations → New registration**
2. Name: `PCI DSS Compliance Platform` (or any name)
3. Supported account types: **Accounts in this organizational directory only (Single tenant)**
4. Redirect URI: select **Web**, then enter:
   - Development: `http://localhost:3000/api/auth/callback/azure-ad`
   - Production: `https://<your-app-domain>/api/auth/callback/azure-ad`
5. Click **Register**

Record the following values — you'll need them in your `.env` file:
- **Application (client) ID** → `AZURE_AD_CLIENT_ID`
- **Directory (tenant) ID** → `AZURE_AD_TENANT_ID`

### 1.2 Create a Client Secret

1. In the App Registration, go to **Certificates & secrets → Client secrets → New client secret**
2. Description: `pci-platform-secret`
3. Expires: 24 months (or per your policy)
4. Click **Add**, then immediately copy the **Value** → `AZURE_AD_CLIENT_SECRET`

> The secret value is only shown once.

### 1.3 API Permissions

1. Go to **API permissions → Add a permission → Microsoft Graph → Delegated permissions**
2. Add: **User.Read** (should already be present by default)
3. Click **Grant admin consent** for your tenant

> `GroupMember.Read.All` is NOT needed. Roles come from App Roles claims in the JWT, not from Graph API group lookups.

### 1.4 Token Configuration

1. Go to **Token configuration → Add optional claim**
2. Token type: **ID**
3. Add: `email`, `family_name`, `given_name`
4. Go to **Token configuration → Add groups claim** — select **None** (we use App Roles, not groups claims)

---

## Part 2 — App Roles

App Roles are defined in the App Registration manifest and show up as the `roles` claim in the JWT when a user with that role signs in.

### 2.1 Add App Roles via the portal

1. In the App Registration, go to **App roles → Create app role**
2. Create the following four roles:

| Display name | Value | Allowed member types | Description |
|---|---|---|---|
| PCI Admin | `PCI.Admin` | Users/Groups | Full admin access |
| PCI Control Owner | `PCI.ControlOwner` | Users/Groups | Manage status and evidence for assigned domains |
| PCI Operator | `PCI.Operator` | Users/Groups | Update status for assigned domains |
| PCI Viewer | `PCI.Viewer` | Users/Groups | Read-only access |

> Make sure **"Do you want to enable this app role?"** is checked for each.

### 2.2 Verify manifest (optional)

After adding roles via the portal, you can verify they exist in **Manifest** under `appRoles`. It should look like:

```json
"appRoles": [
  {
    "allowedMemberTypes": ["User"],
    "description": "Full admin access",
    "displayName": "PCI Admin",
    "id": "<auto-generated-guid>",
    "isEnabled": true,
    "value": "PCI.Admin"
  },
  {
    "allowedMemberTypes": ["User"],
    "description": "Manage status and evidence for assigned domains",
    "displayName": "PCI Control Owner",
    "id": "<auto-generated-guid>",
    "isEnabled": true,
    "value": "PCI.ControlOwner"
  },
  {
    "allowedMemberTypes": ["User"],
    "description": "Update status for assigned domains",
    "displayName": "PCI Operator",
    "id": "<auto-generated-guid>",
    "isEnabled": true,
    "value": "PCI.Operator"
  },
  {
    "allowedMemberTypes": ["User"],
    "description": "Read-only access",
    "displayName": "PCI Viewer",
    "id": "<auto-generated-guid>",
    "isEnabled": true,
    "value": "PCI.Viewer"
  }
]
```

---

## Part 3 — Enterprise Application (Group → Role Assignment)

When you create an App Registration, Azure also creates a corresponding **Enterprise Application** (also called a Service Principal). This is where you assign groups to App Roles.

### 3.1 Navigate to the Enterprise Application

1. Go to **Microsoft Entra ID → Enterprise applications**
2. Search for `PCI DSS Compliance Platform` (the name from your App Registration)
3. Open it

### 3.2 Require assignment (recommended)

1. Go to **Properties**
2. Set **Assignment required** to **Yes** — only users/groups explicitly assigned will be able to log in
3. **Save**

### 3.3 Assign Entra groups to App Roles

1. Go to **Users and groups → Add user/group**
2. Click **Users and groups** and search for the Entra security group you want to assign
3. Click **Select a role** and pick the appropriate App Role (e.g., `PCI Admin`)
4. Click **Assign**
5. Repeat for each group → role mapping

> Any user who is a member of an assigned group will receive that role in their JWT when they sign in.

---

## Part 4 — SCIM Provisioning

SCIM allows Azure AD to automatically create, update, and deactivate users in the platform — even before they first log in. This is how all enterprise SaaS apps (Slack, ServiceNow, Zoom) integrate with M365.

### 4.1 Generate a SCIM secret

On your server or locally, run:

```bash
openssl rand -base64 32
```

Copy this value into your `.env` as `SCIM_PROVISIONING_SECRET`. This same value goes into the Azure portal in the next step.

### 4.2 Configure provisioning in Azure

1. In the Enterprise Application, go to **Provisioning**
2. Set **Provisioning Mode** to **Automatic**
3. Under **Admin Credentials**:
   - **Tenant URL**: `https://<your-app-domain>/api/scim/v2`
     - Development: use [ngrok](https://ngrok.com/) or similar to expose localhost — `https://<tunnel>/api/scim/v2`
   - **Secret Token**: paste the value of `SCIM_PROVISIONING_SECRET`
4. Click **Test Connection** — Azure will call `GET /api/scim/v2/ServiceProviderConfig`
5. If the test passes, click **Save**

### 4.3 Configure attribute mappings (optional)

By default, Azure maps:
- `userPrincipalName` → `userName`
- `displayName` → `name.formatted`
- `accountEnabled` → `active`

These defaults work without any changes.

### 4.4 Set provisioning scope

1. Under **Settings**, set **Scope** to **Sync only assigned users and groups**
2. Click **Save**

### 4.5 Start provisioning

1. Set **Provisioning Status** to **On**
2. Click **Save**

Azure will begin an initial sync cycle within ~40 minutes. Subsequent changes (user added/removed from a group) sync every ~40 minutes automatically. You can trigger an immediate sync with **Provision on demand**.

### 4.6 How roles flow through SCIM

When Azure provisions a user, it sends their role assignments (from step 3.3) as part of the SCIM payload. The platform's SCIM endpoint maps the App Role values to `PlatformRole` enum values and stores them in `User.platformRoles`.

---

## Part 5 — Environment Variables

After completing the above, your `.env` should have:

```env
AZURE_AD_CLIENT_ID="<Application (client) ID from App Registration>"
AZURE_AD_CLIENT_SECRET="<Client secret value>"
AZURE_AD_TENANT_ID="<Directory (tenant) ID>"
NEXTAUTH_SECRET="<run: openssl rand -base64 32>"
NEXTAUTH_URL="http://localhost:3000"   # or your production URL
SCIM_PROVISIONING_SECRET="<same value entered in Azure portal>"
```

---

## Summary flow

```
Entra group membership
        ↓
Azure assigns App Role to user (in Enterprise App)
        ↓
SCIM pushes user to platform (creates User record, sets platformRoles)
        ↓
User signs in → JWT contains `roles` claim → signIn callback updates platformRoles
        ↓
Admin assigns DomainAssignment (which domain the user is responsible for)
        ↓
User sees their assigned items in My Controls
```
